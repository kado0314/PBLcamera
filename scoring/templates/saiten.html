<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ファッション採点</title>
    <link rel="stylesheet" href="../../static/css/fashion.css">
    <link rel="icon" href="https://github.com/kado0314/PBLcamera/blob/main/static/image/huku.png?raw=true" type="image/png">
</head>
<body>
    <h1>ファッション採点</h1>
    <form method="POST" enctype="multipart/form-data" action="{{ url_for('scoring.saiten') }}">
        
        <label>画像をアップロード</label><br>
        <input type="file" name="image_file" accept="image/*" capture="camera" id="imageInput"><br>
        
        <button type="button" id="openCameraBtn">撮影</button><br>
        <div id="cameraArea">
            <video id="cameraVideo" autoplay playsinline></video>
            <button type="button" id="takePhotoBtn">写真を撮る</button>
        </div>
        <img id="imagePreview" src="">

        <label for="user_gender">性別</label><br>
        <select name="user_gender" id="user_gender">
            <option value="neutral" {% if selected_gender == 'neutral' %}selected{% endif %}>指定なし (Neutral)</option>
            <option value="male" {% if selected_gender == 'male' %}selected{% endif %}>男性 (Male)</option>
            <option value="female" {% if selected_gender == 'female' %}selected{% endif %}>女性 (Female)</option>
        </select>
        <br><br>

        <label for="intended_scene">TPO (シーン)</label><br>
        <select name="intended_scene" id="intended_scene">
            <option value="date" {% if selected_scene == 'date' %}selected{% endif %}>デート</option>
            <option value="work" {% if selected_scene == 'work' %}selected{% endif %}>仕事</option>
            <option value="friends" {% if selected_scene == 'friends' %}selected{% endif %}>友達と遊ぶ</option>
            </select>
        <br><br>

        <button type="submit">採点する</button>
    </form>

    {% if uploaded_image_data %}
    <hr>
    <div class="target">
        <h3>採点対象</h3>
        <img src="{{ uploaded_image_data }}" style="max-width:300px;">
    </div>
    {% endif %}

    {% if score is not none %}
    <hr>
    <div class="results">
        <div class="res-head"><h2>採点結果<span class="score">{{ score }} 点</span></h2></div>
        <div class="res-body">
            <div class="rating">
                <p>{{ recommendation }}</p>
                <ul>
                    {% for f in feedback %}
                        <li>{{ f }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% if radar_chart_data %}
            <hr>
            <div class="chart">
                <img src="{{ radar_chart_data }}" alt="レーダーチャート" style="max-width:400px;">
            </div>
        </div>
    </div>
    {% endif %}
    <script>
    // 1. ファイル選択フィールドとプレビュー要素を取得
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');

    // 2. ファイルが選択されたときのイベントリスナーを設定
        imageInput.addEventListener('change', function(event) {
        // 選択されたファイルを取得
            const file = event.target.files[0];
        
            if (file) {
            // ファイルリーダーを作成し、ファイルの内容を読み込む
                const reader = new FileReader();
            
                reader.onload = function(e) {
                // 読み込み完了後、プレビュー要素のsrc属性に設定
                    imagePreview.src = e.target.result;
                // プレビュー要素を表示状態にする
                    imagePreview.style.display = 'block';
                };
            
            // ファイルをData URL (Base64) として読み込む
                reader.readAsDataURL(file);
            } else {
            // ファイル選択がキャンセルされた場合、プレビューを非表示にする
                imagePreview.src = '';
                imagePreview.style.display = 'none';
            }
        });

        // カメラ関連の要素取得
        const openCameraBtn = document.getElementById('openCameraBtn');
        const cameraArea = document.getElementById('cameraArea');
        const cameraVideo = document.getElementById('cameraVideo');
        const takePhotoBtn = document.getElementById('takePhotoBtn');

        let cameraStream = null;

        // ① 「撮影」ボタンを押してカメラ起動
        openCameraBtn.addEventListener('click', async () => {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraVideo.srcObject = cameraStream;

                cameraArea.style.display = "block";
                imagePreview.style.display = "none"; // プレビュー非表示
            } catch (err) {
                alert("カメラを起動できませんでした: " + err);
            }
        });

        // ② 「写真を撮る」で現在のカメラ映像をキャプチャ
        takePhotoBtn.addEventListener('click', () => {
            if (!cameraStream) return;

            const canvas = document.createElement('canvas');
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);

            // 画像データを Base64 に変換
            const dataUrl = canvas.toDataURL("image/jpeg");

            // プレビュー表示
            imagePreview.src = dataUrl;
            imagePreview.style.display = "block";

            // Base64 を <input type="file"> に変換してセット
            fetch(dataUrl)
                .then(res => res.arrayBuffer())
                .then(buffer => {
                    const file = new File([buffer], "camera.jpg", { type: "image/jpeg" });
            
                    const dt = new DataTransfer();
                    dt.items.add(file);

                    imageInput.files = dt.files;  // Flask に送れる！
                });

            // カメラ停止
            cameraStream.getTracks().forEach(track => track.stop());
            cameraArea.style.display = "none";
        });
    </script>
</body>
</html>



